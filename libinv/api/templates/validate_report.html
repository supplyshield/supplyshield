<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.0.0-alpha.6/js/bootstrap.min.js"></script>

        <style>
            .bd-placeholder-img {
              font-size: 1.125rem;
              text-anchor: middle;
              -webkit-user-select: none;
              -moz-user-select: none;
              user-select: none;
            }
      
            @media (min-width: 768px) {
              .bd-placeholder-img-lg {
                font-size: 3.5rem;
              }
            }
      
            .b-example-divider {
              height: 3rem;
              background-color: rgba(0, 0, 0, .1);
              border: solid rgba(0, 0, 0, .15);
              border-width: 1px 0;
              box-shadow: inset 0 .5em 1.5em rgba(0, 0, 0, .1), inset 0 .125em .5em rgba(0, 0, 0, .15);
            }
      
            .b-example-vr {
              flex-shrink: 0;
              width: 1.5rem;
              height: 100vh;
            }
      
            .bi {
              vertical-align: -.125em;
              fill: currentColor;
            }
      
            .nav-scroller {
              position: relative;
              z-index: 2;
              height: 2.75rem;
              overflow-y: hidden;
            }
      
            .nav-scroller .nav {
              display: flex;
              flex-wrap: nowrap;
              padding-bottom: 1rem;
              margin-top: -1px;
              overflow-x: auto;
              text-align: center;
              white-space: nowrap;
              -webkit-overflow-scrolling: touch;
            }
            .input-group {
              margin-top: 30px;
              position: relative;
            }

            .input-group {
              position: relative;
            }

            .input-group-addon {
              border: none;
            }

            .linkname {
              display: none;
            }

            #copyButton {
              cursor: pointer;
              background: #f1bb3a;
            }

            #copyTarget {
              border-left: none;
            }

            .copied {
              opacity: 1;
              position: absolute;
              left: 55px;
            }

            .col-md-2pt5 {
              flex: 0 0 auto;
              width: 20%;
            }

            .loading-screen {
              position: fixed;
              top: 0;
              left: 0;
              width: 100%;
              height: 100%;
              background-color: white;
              display: flex;
              justify-content: center;
              align-items: center;
              font-size: 20px;
              color: black;
              opacity: 75%;
              z-index: 1000; /* Ensure it's above other content */
            }

            @media (min-width: 768px) {
              .copied {
                left: 135px;
              }

              .linkname {
                display: block;
                background: #3b3e45;
                color: #fff;
              }
            }
          </style>
    </head>

    <body>
        <nav class="navbar navbar-expand-md navbar-dark bg-dark mb-4">
            <div class="container-fluid">
              <a class="navbar-brand" href="#">Libinv</a>
              <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
              </button>
              <div class="collapse navbar-collapse" id="navbarCollapse">
                <ul class="navbar-nav me-auto mb-2 mb-md-0">
                  <li class="nav-item">
                    <a class="nav-link active" aria-current="page" href="#">Home</a>
                  </li>
                </ul>
                <form class="d-flex" role="search">
                  <input class="form-control me-2" type="search" placeholder="Search with id" aria-label="Search">
                  <button class="btn btn-outline-success" type="submit">Search</button>
                </form>
              </div>
            </div>
          </nav>

          <div class="flex-shrink-0">
            <div class="container">
              <h1 class="mt-3">Validate Result</h1>

              <div class="row mb-2">
                <div class="col-md-7" style="background-color: #f8f8f8;">
                  <!-- Left  -->
                  <ul class="list-unstyled">
                    <li class="col-md-11  gap-3 align-items-start align-items-lg-center py-1 link-body-emphasis text-decoration-none border-top">
                      <div class="input-group mb-3">
                        <span class="input-group-text linkname col-md-2pt5" id="basic-addon1">Issue Title</span>
                        <span id="copyButton" class="input-group-text" title="Click to copy" onclick="copyit(event)">
                          <i class="fa fa-clipboard" aria-hidden="true"></i>
                        </span>
                        <input type="text" class="form-control" placeholder="Title" value="{{ result.lob_metadata.repository.pod | title }} | {{ result.lob_metadata.module | upper }}" aria-label="title" aria-describedby="basic-addon1">
                      </div>
                    </li>

                    <li class="col-md-11  gap-3 align-items-start align-items-lg-center py-1 link-body-emphasis text-decoration-none border-top">
                      <div class="input-group mb-3">
                        <span class="input-group-text linkname col-md-2pt5" id="basic-addon1">Backend Repo</span>
                        <span id="copyButton" class="input-group-text" title="Click to copy"  onclick="copyit(event)">
                          <i class="fa fa-clipboard" aria-hidden="true"></i>
                        </span>
                        <input type="text" class="form-control" placeholder="Title" value="{{ result.githubpath }}" aria-label="Username" aria-describedby="basic-addon1">
                      </div>
                    </li>

                    <li class="col-md-11  gap-3 align-items-start align-items-lg-center py-1 link-body-emphasis text-decoration-none border-top">
                      <div class="input-group mb-3">
                        <span class="input-group-text linkname col-md-2pt5" id="basic-addon1">POD</span>
                        <span id="copyButton" class="input-group-text" title="Click to copy"  onclick="copyit(event)">
                          <i class="fa fa-clipboard" aria-hidden="true"></i>
                        </span>
                        <input type="text" class="form-control" placeholder="Title" value="{{ result.lob_metadata.repository.pod  }}" aria-label="Username" aria-describedby="basic-addon1">
                      </div>
                    </li>

                    <li class="col-md-11  gap-3 align-items-start align-items-lg-center py-1 link-body-emphasis text-decoration-none border-top">
                      <div class="input-group mb-3">
                        <span class="input-group-text linkname col-md-2pt5" id="basic-addon1">SUBPOD</span>
                        <span id="copyButton" class="input-group-text" title="Click to copy"  onclick="copyit(event)">
                          <i class="fa fa-clipboard" aria-hidden="true"></i>
                        </span>
                        <input type="text" class="form-control" placeholder="Title" value="{{ result.lob_metadata.repository.subpod  }}" aria-label="Username" aria-describedby="basic-addon1">
                      </div>
                    </li>

                    {% if result.public_initial_point != "{}" %}

                    <li class="col-md-11  gap-3 align-items-start align-items-lg-center py-1 link-body-emphasis text-decoration-none border-top">
                      <div class="input-group mb-3">
                        <span class="input-group-text linkname col-md-2pt5" id="basic-addon1">Public Endpoint</span>
                        <span id="copyButton" class="input-group-text" title="Click to copy"  onclick="copyit(event)">
                          <i class="fa fa-clipboard" aria-hidden="true"></i>
                        </span>
                        <input type="text" class="form-control" placeholder="Title" value="{{ result.public_initial_point }}" aria-label="Username" aria-describedby="basic-addon1">
                      </div>
                    </li>

                    {% endif %}

                    <li class="col-md-11  gap-3 align-items-start align-items-lg-center py-1 link-body-emphasis text-decoration-none border-top">
                      <div class="input-group mb-3">
                        <span class="input-group-text linkname col-md-2pt5" id="basic-addon1">BUG ID</span>
                        <span id="copyButton" class="input-group-text" title="Click to copy"  onclick="copyit(event)">
                          <i class="fa fa-clipboard" aria-hidden="true"></i>
                        </span>
                        <input type="text" class="form-control" placeholder="Title" value="{{ result.id  }}" aria-label="Username" aria-describedby="basic-addon1">
                      </div>
                    </li>
                  </ul>
                </div>
                <div class="col-md-5" style="background-color: #f8f8f8;">
                  <!-- here fade in Right -->
                  <ul class="list-unstyled">
                    <li class="col-md-12  gap-3 align-items-start align-items-lg-center py-1 link-body-emphasis text-decoration-none border-top" id="secreview-container" style="display: none;">
                      <div class="input-group mb-3">
                        <span class="input-group-text linkname col-md-3" id="basic-addon1">SECBUG ID</span>
                        <input type="text" id="reviewid" class="form-control" placeholder="SECBUG ID" aria-label="reviewid" aria-describedby="basic-addon1">
                      </div>
                    </li>
                    <li class="col-md-12  gap-3 align-items-start align-items-lg-center py-1 link-body-emphasis text-decoration-none border-top" id="description-container" style="display: none;">
                      <div class="input-group mb-3">
                        <span class="input-group-text linkname col-md-3" id="basic-addon1">Description</span>
                        <textarea class="form-control" rows="5" id="description"></textarea>
                      </div>
                    </li>
                  </ul>
                </div>
              </div>  

              <div class="container border-top pt-3 pb-4">
                <div class="btn-group" role="group" aria-label="Basic radio toggle button group">
                  <input type="radio" class="btn-check" name="btnradio" id="btnradio1" autocomplete="off"  value="intended">
                  <label class="btn btn-lg btn-outline-primary " for="btnradio1" onclick="showdescription()">False Positive / Intended</label>
                
                  <input type="radio" class="btn-check" name="btnradio" id="btnradio2" autocomplete="off" value="ticket">
                  <label class="btn btn-lg btn-outline-primary" for="btnradio2" onclick="showsecreview(true)">Create Ticket</label>
                
                  <input type="radio" class="btn-check" name="btnradio" id="btnradio3" autocomplete="off" value="dupe">
                  <label class="btn btn-lg btn-outline-primary" for="btnradio3" onclick="showsecreview()">Duplicate</label>
                </div>
              </div>

              <div class="container border-top pt-3">
                <button type="button" class="btn btn-success" onclick="submit(event)">Submit</button>

              </div>

            </div>

            <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
              <div id="liveToast" class="toast hide" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="toast-header">
                  <i class="fa-solid fa-check" style="color: green;"></i>
                  <strong class="me-auto">Libinv</strong>
                  <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
                <div class="toast-body" id="toastbody">
                  Copied
                </div>
              </div>
            </div>

            <div id="loadingScreen" class="loading-screen" style="display: none;">
              <div class="spinner-border text-secondary" role="status">
                <span class="sr-only">Loading, please wait...</span>
              </div>
              Loading, please wait..
              
            </div>
          </div>
        
          
          <script>

            let init_data = {"validated": {{result.validated}}, "secreviewid": "{{result.secbugurl}}", "desciption": "{{result.description}}"}
            
            if (init_data["validated"] == 1){
              document.getElementById('btnradio2').checked = true;
              showsecreview()
              document.getElementById("reviewid").value = init_data["secreviewid"]
            } else if (init_data["validated"] == 2) {
              document.getElementById('btnradio1').checked = true;
              showdescription()
              document.getElementById("description").value = init_data["desciption"]
            } else if (init_data["validated"] == 3) {
              document.getElementById('btnradio3').checked = true;
              showsecreview()
              document.getElementById("reviewid").value = init_data["secreviewid"]
            }
            

            function toast(msg) {
              document.getElementById("toastbody").innerText = msg;
              var a = new bootstrap.Toast(document.getElementById("liveToast"));
              a.show()
            }

            window.addEventListener("message", (e)=>{
              data = JSON.parse(e.data);
              document.getElementById("reviewid").value = data.secreviewid;

            })

           function copyToClipboard(elem) {
              var target = elem;

              // select the content
              var currentFocus = document.activeElement;

              target.focus();
              target.setSelectionRange(0, target.value.length);

              // copy the selection
              var succeed;

              try {
                succeed = document.execCommand("copy");
              } catch (e) {
                console.warn(e);

                succeed = false;
              }

              // Restore original focus
              if (currentFocus && typeof currentFocus.focus === "function") {
                currentFocus.focus();
              }

              if (succeed) {
                toast("Copied")
                target.style.borderColor = "green";
                setTimeout(()=>{
                  target.style.borderColor = "lightgray";
                }, 1000)
              }

              return succeed;
            
            }

            function copyit(e){
              var target = e.target.parentElement
              if (target.id === "") {
                target = e.target.nextElementSibling
              }else{
                target = e.target.parentElement.nextElementSibling
              }
              copyToClipboard(target)
            }
            
            function hideall(){
              document.getElementById("description-container").style.display = "none"
              document.getElementById("secreview-container").style.display = "none"
            }

            function showdescription() {
              hideall()
              document.getElementById("description-container").style.display = "block"
            }
            function showsecreview(called_from_init) {
              hideall()
              document.getElementById("secreview-container").style.display = "block"

              if (called_from_init === true) {
                win = window.open("https://web/new_secreview");
                setTimeout((e)=>{
                  data = {
                    "title":"{{ result.lob_metadata.repository.pod | title }} | {{ result.lob_metadata.module | upper }}",
                    "codeurl": "{{ result.githubpath }}",
                    "foundby": "{{ result.source | lower|capitalize }}",
                    "lob":"{{ result.lob_metadata.repository.pod  }}",
                    "pod":"{{ result.lob_metadata.repository.pod  }}"
                  }

                  win.postMessage(JSON.stringify(data), "*")
                }, 5000)

              }
             
            }

            
            
            function submit(e){
              var selector =  document.querySelector('input[name="btnradio"]:checked')
              if (selector == null) {
                alert("Choose from False Positive, duplicate or create ticket");
              }
              val = selector.value;
              params = {}

              if(val === "intended") {
                // # intended or false +ve
                params["validated"] = "FALSEPOSITIVE"
                params["data"] = document.getElementById("description").value
                if (!params["data"] || params["data"] === ""){
                  alert("Description cannot be empty.")
                  return
                }
              }else if(val === "dupe") {
                params["validated"] = "Duplicate"
                params["data"] = document.getElementById("reviewid").value
                if (!params["data"] || params["data"] === ""){
                  alert("Secreview Ticket is needed.")
                  return
                }
              }else if(val === "ticket") {
                params["validated"] = "VALIDATED"
                params["data"] = document.getElementById("reviewid").value
                if (!params["data"] || params["data"] === ""){
                  alert("Secreview Ticket is needed.")
                  return
                }
              } else {
                alert("invalid choice")
              }
              params["sec_id"] = "{{ result.id }}";

              loadingScreen.style.display = 'flex';

              fetch("/libinv/sast/update", {
                method: "PUT",
                headers: {
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify(params)
              })
              .then(response => response.json())
              .then(data => {
                if (data.error === null) {
                  toast("SUCCESSFULL")
                } else {
                  toast(data.error)
                }
                loadingScreen.style.display = 'none';
              })
              .catch(error => {
                console.error('Error:', error)
                loadingScreen.style.display = 'none';
              });


            }

          </script>
    </body>
</html>
